!function(a){var b=angular.module("AngularAOP",[]);b.factory("execute",["$q",function(b){function c(a){this._advice=a,this._wrapperFunc=null}function d(a){this.before=AspectBuilder.buildAspect(a,POINTCUTS.BEFORE),this.after=AspectBuilder.buildAspect(a,POINTCUTS.AFTER),this.around=AspectBuilder.buildAspect(a,POINTCUTS.AROUND),this.onThrowOf=AspectBuilder.buildAspect(a,POINTCUTS.ON_THROW),this.onResolveOf=AspectBuilder.buildAspect(a,POINTCUTS.ON_RESOLVE),this.afterResolveOf=AspectBuilder.buildAspect(a,POINTCUTS.AFTER_RESOLVE),this.onRejectOf=AspectBuilder.buildAspect(a,POINTCUTS.ON_REJECT)}var e=Array.prototype.slice,f=function(){var a;return a="function"==typeof String.prototype.trim?String.prototype.trim:function(){return null===this?"":(this+"").replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}}(),g=/.*/;return POINTCUTS={BEFORE:"Before",AFTER:"After",AROUND:"Around",ON_THROW:"OnThrow",ON_RESOLVE:"OnResolve",AFTER_RESOLVE:"AfterResolve",ON_REJECT:"OnReject"},Aspects={},AspectBuilder={buildAspect:function(a,b){var c=this;return function(d,e){return"function"==typeof d?c._getFunctionAspect(d,b,a):d?c._getObjectAspect(d,e||{},b,a):void 0}},_getFunctionAspect:function(a,b,c,d){d=d||this._getMethodName(a);var f=new Aspects[b](c),g=function(){var b=e.call(arguments);return b={args:b,context:this,method:a,methodName:d},f._wrapper.call(f,b)};return g.originalMethod=a,f.setWrapper(g),g},_getMethodName:function(a){for(;a.originalMethod;)a=a.originalMethod;return/function\s+(.*?)\s*\(/.exec(a.toString())[1]},_getObjectAspect:function(a,b,c,d){for(var e in a)a.hasOwnProperty(e)&&"function"==typeof a[e]&&this._matchRules(a,e,b)&&(a[e]=this._getFunctionAspect(a[e],c,d,e));return a},_matchRules:function(a,b,c){for(var d=c.methodPattern||g,e=c.argsPatterns||[],f=a[b],h=this._parseMethod(f,b);"__angularAOPWrapper__"===h.when;)f=f.originalMethod,h=this._parseMethod(f,b);return d.test(h.method)&&this._matchArguments(e,h)},_matchArguments:function(a,b){if(b.args.length<a.length)return!1;var c=!0;return angular.forEach(b.args,function(b,d){var e=a[d]||g;return e.test(b)?void 0:(c=!1,void 0)}),c},_parseMethod:function(a,b){var c={method:b},d=a.toString().match(/function\s+([^\(]*)\s*\(([^\)]*)\)/)||[];return d&&d[2]?(c.args=[],angular.forEach(d[2].split(","),function(a){c.args.push(f.call(a))})):c.args=[],c.when=d[1],c}},c.prototype.setWrapper=function(a){this._wrapperFunc=a},c.prototype._wrapper=function(){throw"Not implemented"},c.prototype.invoke=function(a){var b=(this._wrapperFunc,{});return b.when=this.when,b.method=a.methodName,b.args=a.args,b.exception=a.exception,b.result=a.result,b.resolveArgs=a.resolveArgs,b.rejectArgs=a.rejectArgs,this._advice.call(a.context,b)},Aspects[POINTCUTS.BEFORE]=function(){c.apply(this,arguments),this.when="before"},Aspects[POINTCUTS.BEFORE].prototype=Object.create(c.prototype),Aspects[POINTCUTS.BEFORE].prototype._wrapper=function(a){return this.invoke(a),a.method.apply(a.context,a.args)},Aspects[POINTCUTS.AFTER]=function(){c.apply(this,arguments),this.when="after"},Aspects[POINTCUTS.AFTER].prototype=Object.create(c.prototype),Aspects[POINTCUTS.AFTER].prototype._wrapper=function(a){var b=a.context,c=a.method.apply(b,a.args);return a.result=c,this.invoke(a),c},Aspects[POINTCUTS.AROUND]=function(){c.apply(this,arguments),this.when="around"},Aspects[POINTCUTS.AROUND].prototype=Object.create(c.prototype),Aspects[POINTCUTS.AROUND].prototype._wrapper=function(a){var b,c=a.args,d=a.context,e=a.method;return this.invoke(a),b=e.apply(d,c),a.result=b,this.invoke(a),b},Aspects[POINTCUTS.ON_THROW]=function(){c.apply(this,arguments),this.when="onThrow"},Aspects[POINTCUTS.ON_THROW].prototype=Object.create(c.prototype),Aspects[POINTCUTS.ON_THROW].prototype._wrapper=function(a){var b,c=a.args;try{b=a.method.apply(a.context,c)}catch(d){a.exception=d,this.invoke(a)}return b},Aspects[POINTCUTS.ON_RESOLVE]=function(){c.apply(this,arguments),this.when="onResolve"},Aspects[POINTCUTS.ON_RESOLVE].prototype=Object.create(c.prototype),Aspects[POINTCUTS.ON_RESOLVE].prototype._wrapper=function(a){var b=a.args,c=a.context,d=a.method,e=d.apply(c,b),f=this;return e&&"function"==typeof e.then&&e.then(function(){a.resolveArgs=arguments,f.invoke(a)}),e},Aspects[POINTCUTS.AFTER_RESOLVE]=function(){c.apply(this,arguments),this.when="afterResolve"},Aspects[POINTCUTS.AFTER_RESOLVE].prototype=Object.create(c.prototype),Aspects[POINTCUTS.AFTER_RESOLVE].prototype._wrapper=function(a){var c=a.args,d=a.context,e=a.method,f=b.defer(),g=f.promise,h=e.apply(d,c),i=this;return h.then(function(){a.resolveArgs=arguments,g.then(function(){i.invoke(a)}),f.resolve.apply(f,arguments)},function(){f.reject.apply(g,arguments)}),g},Aspects[POINTCUTS.ON_REJECT]=function(){c.apply(this,arguments),this.when="onReject"},Aspects[POINTCUTS.ON_REJECT].prototype=Object.create(c.prototype),Aspects[POINTCUTS.ON_REJECT].prototype._wrapper=function(b){var c=b.args,d=b.context,e=b.method,f=e.apply(d,c),g=this;return f&&"function"==typeof f.then&&f.then(a,function(){b.rejectArgs=arguments,g.invoke(b)}),f},function(a){return new d(a)}}])}(void 0);